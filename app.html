<html>
<head>
  <title></title>

  <style type="text/css">
  body {
    font-family:'Helvetica','Arial',sans-serif;
  }
  #canvcont {
    height:480px;
    width:320px;
    background-color:#dddddd;
    overflow:hidden;
  }
  .btn {
    background-color: blue;
    padding:5px;
    color:white;
    max-width:120px;
    cursor:pointer;
    text-align: center;
  }

  .btn:hover {
    background-color: red;

  }
  </style>
  <script src="js/base64.js"></script>
  <script src="js/canvas2image.js"></script>

</head>
<body>
  <div id="btn" class="btn trigger">#<div></div></div>

  <div id="contain">
    <div id="canvcont"></div>
  </div>

<ul id="hairtypes">
  <li type="elv.jpg">nr 1</li>
  <li type="http://www.bluelagoon.is/front2013/gallery/img2.png">nr 2</li>
  <li type="http://www.bluelagoon.is/front2013/gallery/img3.png">nr 3</li>
</ul>
 <div id="increase" scaleby="10" class="btn">+</div>
 <div id="decrease" scaleby="-10" class="btn">-</div>
 <div id="kazaam" class="btn">KAZAAM!</div>
 <div id="result"></div> 


  <script type="text/javascript">


  var context;
  var canvasWidth = 320;
  var canvasHeight = 480;
  var canvas;
  var img;
  var scale;
  var bgImage;
  self = this;
  var btn = document.getElementById('btn');
  var increase = document.getElementById('increase');
  var decrease = document.getElementById('decrease');
  var kazaam = document.getElementById('kazaam');
  var offsetX = 0;
  var offsetY = 0;
  var canvCont;

  var wigHeight = 128;
  var wigWidth = 128;

  var currentX;
  var currentY;
  var currentType;;

  var hairTypeList;

function init() {
  btn.addEventListener("click",buttonClick,false);
  increase.addEventListener("click",scaleHair,false);
  decrease.addEventListener("click",scaleHair,false);
  kazaam.addEventListener("click",onKazaam,false);

   

  self.hairTypeList = document.querySelector('#hairtypes').querySelectorAll('li');

  for(var i=0;i<self.hairTypeList.length;i++) {
    self.hairTypeList[i].addEventListener('mousedown',onHairTypeSelect);
    
  }
}

function buttonClick(event) {
   event.preventDefault();

   if(document.getElementById('canvcont')) {
      self.canvCont = document.getElementById('canvcont');
      self.canvCont.innerHTML = "";
    }else {
      var container = document.getElementById('contain');
      container.innerHTML = '<div id="canvcont"></div>';
      init();
    }

  //INPUT
  //  create input element so the user can
  //  navigate his/her filesystem/camera
  var input = document.createElement("input");
  input.type = "file";
  input.setAttribute("accept","image/*");
  //INPUT SELECT
  //  once the user has selected a file
  //  for upload, the onchange event will fire in which
  //  case an blob url is created and the image is loaded

  input.addEventListener("change",function(event){
    var file = event.target.files[0];
    var URL = window.URL || window.webkitURL;
    var imgURL = URL.createObjectURL(file);
    var img = new Image();

      //IMAGE LOAD
      //  once the image is loaded into memory it has
      //  to be resized, a temporary canvas element is created
      //  and a new image object is used to display the new
      //  thumbnail.
      img.addEventListener("load",function(event){

        //CANVAS
        //  create canvas element that is used as a container
        //  to resize the image
        self.bgImage = event.target;
        self.scale = (event.target.height / event.target.width);
        self.canvas = document.createElement("canvas");
        self.canvas.width = 320;
        self.canvas.height = 320 *self.scale// / 8;
        self.canvasHeight = 320*self.scale;
        self.context = self.canvas.getContext("2d");
        self.canvCont.style.height = self.canvasHeight+"px"
        // context.drawImage(event.target,0,0,event.target.width,event.target.height);


        self.context.drawImage(self.bgImage,0,0,320,320*self.scale);
        self.canvCont.appendChild(self.canvas);


      },false);
        //ORIGINAL IMAGE
        //  first set src of the original image (so that the onload event
        //  will fire) and the that free the object-url resource.
  img.src = imgURL;
  URL.revokeObjectURL(imgURL);

  },false);

  document.body.appendChild(input);
  input.style.display = "none";
  input.click();

  enableSelectHair()

}

function enableSelectHair() {
    onHairSelected();
}

function onHairTypeSelect(e) {
  var type = e.target.getAttribute('type');
  self.img.src = type;
  self.currentType = type;
}

function onHairSelected() {
  self.img = new Image();

  self.img.onload = function(){
    console.log('img loaded')
   canMouseX = 0;
   canMouseY = 0;
   render(true);
  
  };
  self.img.src = "http://images.christmastimeclipart.com/images/2/1271716593176_1788/img_1271716593176_17881.jpg";

    addDragHandlers(true);

}

function addDragHandlers(addHandlers) {
  if(addHandlers) {
    self.canvCont.addEventListener('mousedown',handleMouseDown,false);
    self.canvCont.addEventListener('mouseup',handleMouseUp,false);
    self.canvCont.addEventListener('mouseout',handleMouseOut,false);
    self.canvCont.addEventListener('mousemove',handleMouseMove,false);
  }else {
    self.canvCont.removeEventListener('mousedown',handleMouseDown,false);
    self.canvCont.removeEventListener('mouseup',handleMouseUp,false);
    self.canvCont.removeEventListener('mouseout',handleMouseOut,false);
    self.canvCont.removeEventListener('mousemove',handleMouseMove,false);
  }
}

function handleMouseDown(e){
  canMouseX=parseInt(e.clientX -offsetX);
  canMouseY=parseInt(e.clientY -offsetY);
      // set the drag flag
      isDragging=true;
}

function handleMouseUp(e){
  canMouseX=parseInt(e.clientX-offsetX);
  canMouseY=parseInt(e.clientY-offsetY);
  // clear the drag flag
  isDragging=false;
}

function handleMouseOut(e){
  canMouseX=parseInt(e.clientX-offsetX);
  canMouseY=parseInt(e.clientY-offsetY);
  // user has left the canvas, so clear the drag flag
  //isDragging=false;
}

function handleMouseMove(e){
  canMouseX=parseInt(e.clientX-offsetX);
  canMouseY=parseInt(e.clientY-offsetY);
  // if the drag flag is set, clear the canvas and draw the image
  if(isDragging){
   
      render(true);
  }
}

function render(isDragging) {

   if(isDragging) {
      //self.currentX = canMouseX-128/2;
      //self.currentY = canMouseY-120/2;
      self.currentX = canMouseX-self.wigWidth/2;
      self.currentY = canMouseY-self.wigHeight/2;
    }

    context.clearRect(0,0,canvasWidth,canvasHeight);
    self.context.drawImage(self.bgImage,0,0,320,320*self.scale);

  
      context.drawImage(img,self.currentX,self.currentY,self.wigWidth,self.wigHeight);
   
    
}

function scaleHair(e) {
  var scaleFactor = parseInt(e.target.getAttribute('scaleby'),10)
  console.log(scaleFactor)
  self.wigWidth += scaleFactor;
  self.wigHeight += scaleFactor;
  console.log(self.wigWidth)
  console.log(self.wigHeight)
  render(false);
}

function onKazaam() {


 self.img.src = self.currentType.replace('.jpg','_horn.jpg');

  var oImg = Canvas2Image.saveAsPNG(self.canvas,true);  // will prompt the user to save the image as PNG.  
  if (!oImg) {
      alert("Sorry, this browser is not capable of saving " + strType + " files!");
      return false;
    }

    oImg.id = "canvasimage";

    oImg.style.border = self.canvas.style.border;
    var container = document.getElementById('contain');

   container.replaceChild(oImg, canvCont);
    addDragHandlers(false)
}

init();

    </script>
  </body>
  </html>